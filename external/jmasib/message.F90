! counter.F90 - 深刻でない事象のカウンタ
!
! #define CHECK すると直接出力になる

MODULE MESSAGE

  IMPLICIT NONE
  PRIVATE

  INTEGER, PARAMETER:: TABLE_SIZE = 100

  INTEGER, SAVE:: TABLE_USED = 0
  CHARACTER(LEN = 66), SAVE:: MESSAGE_TABLE(TABLE_SIZE)
  INTEGER, SAVE:: COUNT_TABLE(TABLE_SIZE)
  TYPE DATE_T
    INTEGER:: YEAR, MON, DAY, HOUR
  END TYPE
  TYPE(DATE_T), SAVE:: CURRENT_DATE = DATE_T(0, 0, 0, 0)
  TYPE(DATE_T), SAVE:: FIRST_DATE_TABLE(TABLE_SIZE)
  TYPE(DATE_T), SAVE:: LAST_DATE_TABLE(TABLE_SIZE)

  PUBLIC:: MESSAGE_INI               ! 初期化
  PUBLIC:: MESSAGE_SETIDATE          ! 時刻設定
  PUBLIC:: MESSAGE_PUT               ! カウントまたは直接出力
  PUBLIC:: MESSAGE_FLUSH             ! カウントされていれば出力

CONTAINS

  SUBROUTINE MESSAGE_INI()
    TABLE_USED = 0
    CURRENT_DATE = DATE_T(0, 0, 0, 0)
  END SUBROUTINE

  SUBROUTINE MESSAGE_SETIDATE(IDATE)
    INTEGER, INTENT(IN):: IDATE(5)
    CURRENT_DATE = DATE_T(IDATE(1), IDATE(2), IDATE(3), IDATE(4))
  END SUBROUTINE

  SUBROUTINE MESSAGE_PUT(MESSAGE)
    CHARACTER(LEN = *), INTENT(IN):: MESSAGE
#   ifdef CHECK
    WRITE(6, "(i4.4,3('-',i2.2),': ',a)") &
      CURRENT_DATE_%YEAR, CURRENT_DATE_%MON, &
      CURRENT_DATE_%DAY, CURRENT_DATE_%HOUR, &
      TRIM(MESSAGE_TABLE(IDX))
#   else
    INTEGER:: IDX
    DO, IDX = 1, TABLE_USED
      IF (MESSAGE_TABLE(IDX) == MESSAGE) GOTO 1000
    ENDDO
    TABLE_USED = TABLE_USED + 1
    IDX = TABLE_USED
    IF (IDX > TABLE_SIZE) THEN
      WRITE(6, *) 'MESSAGE_PUT: TOO MANY KIND OF MESSAGES'
      STOP 999
    ENDIF
    FIRST_DATE_TABLE(IDX) = CURRENT_DATE
    COUNT_TABLE(IDX) = 0
    1000 CONTINUE
    MESSAGE_TABLE(IDX) = MESSAGE
    LAST_DATE_TABLE(IDX) = CURRENT_DATE
    COUNT_TABLE(IDX) = COUNT_TABLE(IDX) + 1
#   endif
  END SUBROUTINE

  SUBROUTINE MESSAGE_FLUSH()
#   ifndef CHECK
    INTEGER:: IDX
    IF (TABLE_USED > 0) THEN
      WRITE(6, "(' --- WARNING SUMMARY ---')")
      WRITE(6, "(' ',2(a13,'/'),a9,': ',a)") 'FIRST', 'LAST', 'TIMES', 'MESSAGE'
    ENDIF
    DO, IDX = 1, TABLE_USED
      WRITE(6, "(' ',2(i4.4,3('-',i2.2),'/'),i9,': ',a)") &
        FIRST_DATE_TABLE(IDX)%YEAR, FIRST_DATE_TABLE(IDX)%MON, &
        FIRST_DATE_TABLE(IDX)%DAY, FIRST_DATE_TABLE(IDX)%HOUR, &
        LAST_DATE_TABLE(IDX)%YEAR, LAST_DATE_TABLE(IDX)%MON, &
        LAST_DATE_TABLE(IDX)%DAY, LAST_DATE_TABLE(IDX)%HOUR, &
        COUNT_TABLE(IDX), TRIM(MESSAGE_TABLE(IDX))
    END DO 
    IF (TABLE_USED > 0) THEN
      WRITE(6, "(' --- WARNING SUMMARY END ---')")
    ENDIF
#   endif
  END SUBROUTINE

END MODULE
